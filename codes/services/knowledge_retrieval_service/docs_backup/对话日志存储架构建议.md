# å¯¹è¯æ—¥å¿—å­˜å‚¨æ¶æ„å»ºè®®

## ğŸ¯ é—®é¢˜åˆ†æ

æ‚¨æå‡ºçš„é—®é¢˜éå¸¸å…³é”®ï¼š**å¯¹è¯æ—¥å¿—å­˜å‚¨æ”¾åœ¨RAGæœåŠ¡å±‚æ˜¯å¦åˆé€‚ï¼Ÿ**

## ğŸ“Š å½“å‰ç³»ç»Ÿæ¶æ„åˆ†æ

### ç³»ç»Ÿå±‚æ¬¡ç»“æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ™ºè¯Šé€šç³»ç»Ÿæ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   å‰ç«¯å±‚        â”‚    â”‚   åç«¯APIå±‚     â”‚                â”‚
â”‚  â”‚  (Vue.js)       â”‚    â”‚  (FastAPI)      â”‚                â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚                â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·ç•Œé¢      â”‚    â”‚ â€¢ ä¸šåŠ¡é€»è¾‘      â”‚                â”‚
â”‚  â”‚ â€¢ æœ¬åœ°å­˜å‚¨      â”‚    â”‚ â€¢ æ•°æ®åº“ç®¡ç†    â”‚                â”‚
â”‚  â”‚ â€¢ çŠ¶æ€ç®¡ç†      â”‚    â”‚ â€¢ ç”¨æˆ·è®¤è¯      â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚           â”‚                       â”‚                        â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                       â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              RAGæœåŠ¡å±‚                                  â”‚ â”‚
â”‚  â”‚  (knowledge_retrieval_service)                          â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚ â€¢ çŸ¥è¯†æ£€ç´¢                                              â”‚ â”‚
â”‚  â”‚ â€¢ AIå›ç­”ç”Ÿæˆ                                            â”‚ â”‚
â”‚  â”‚ â€¢ å‘é‡åŒ–å¤„ç†                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ å¯¹è¯æ—¥å¿—å­˜å‚¨ä½ç½®å»ºè®®

### âœ… **æ¨èæ–¹æ¡ˆï¼šåç«¯APIå±‚å­˜å‚¨**

**ä½ç½®**: `codes/backend/app/modules/conversation/`

**ä¼˜åŠ¿**:
1. **èŒè´£æ¸…æ™°**: åç«¯è´Ÿè´£ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®æŒä¹…åŒ–
2. **æ•°æ®ä¸€è‡´æ€§**: ç»Ÿä¸€çš„æ•°æ®åº“ç®¡ç†ï¼Œé¿å…æ•°æ®åˆ†æ•£
3. **å®‰å…¨æ€§**: åç«¯å¯ä»¥æ§åˆ¶æ•°æ®è®¿é—®æƒé™
4. **å¯æ‰©å±•æ€§**: æ”¯æŒå¤šç”¨æˆ·ã€å¤šä¼šè¯ç®¡ç†
5. **å®¡è®¡è¿½è¸ª**: å®Œæ•´çš„æ“ä½œæ—¥å¿—å’Œç”¨æˆ·è¡Œä¸ºè®°å½•

### âŒ **ä¸æ¨èï¼šRAGæœåŠ¡å±‚å­˜å‚¨**

**åŸå› **:
1. **èŒè´£æ··ä¹±**: RAGæœåŠ¡ä¸“æ³¨äºçŸ¥è¯†æ£€ç´¢ï¼Œä¸åº”æ‰¿æ‹…æ•°æ®å­˜å‚¨èŒè´£
2. **æ•°æ®å­¤å²›**: å¯¹è¯æ—¥å¿—ä¸ç”¨æˆ·æ•°æ®åˆ†ç¦»ï¼Œéš¾ä»¥ç®¡ç†
3. **é‡å¤å­˜å‚¨**: å¯èƒ½å¯¼è‡´æ•°æ®å†—ä½™å’Œä¸ä¸€è‡´
4. **ç»´æŠ¤å›°éš¾**: å¤šä¸ªæœåŠ¡éƒ½éœ€è¦å¤„ç†å­˜å‚¨é€»è¾‘

## ğŸ”„ æ­£ç¡®çš„æ•°æ®æµå‘è®¾è®¡

### æ–¹æ¡ˆä¸€ï¼šåç«¯ç»Ÿä¸€ç®¡ç†ï¼ˆæ¨èï¼‰

```
ç”¨æˆ·è¾“å…¥ â†’ å‰ç«¯ â†’ åç«¯API â†’ RAGæœåŠ¡ â†’ åç«¯API â†’ å‰ç«¯
                â†“                    â†“
            å¯¹è¯æ—¥å¿—å­˜å‚¨          AIå›ç­”ç”Ÿæˆ
                â†“                    â†“
            æ•°æ®åº“æŒä¹…åŒ–          è¿”å›ç»™åç«¯
```

**å®ç°æ–¹å¼**:
1. å‰ç«¯å‘é€æ¶ˆæ¯åˆ°åç«¯API
2. åç«¯è°ƒç”¨RAGæœåŠ¡è·å–AIå›ç­”
3. åç«¯å°†ç”¨æˆ·è¾“å…¥å’ŒAIå›ç­”å­˜å‚¨åˆ°æ•°æ®åº“
4. åç«¯è¿”å›å®Œæ•´ç»“æœç»™å‰ç«¯

### æ–¹æ¡ˆäºŒï¼šRAGæœåŠ¡å›è°ƒï¼ˆå¤‡é€‰ï¼‰

```
ç”¨æˆ·è¾“å…¥ â†’ å‰ç«¯ â†’ åç«¯API â†’ RAGæœåŠ¡ â†’ åç«¯API â†’ å‰ç«¯
                â†“                    â†“
            å¯¹è¯æ—¥å¿—å­˜å‚¨          AIå›ç­”ç”Ÿæˆ
                â†“                    â†“
            æ•°æ®åº“æŒä¹…åŒ–          å›è°ƒå­˜å‚¨
```

**å®ç°æ–¹å¼**:
1. å‰ç«¯å‘é€æ¶ˆæ¯åˆ°åç«¯API
2. åç«¯è°ƒç”¨RAGæœåŠ¡ï¼Œä¼ é€’å›è°ƒå‡½æ•°
3. RAGæœåŠ¡ç”Ÿæˆå›ç­”åï¼Œé€šè¿‡å›è°ƒå­˜å‚¨å¯¹è¯æ—¥å¿—
4. è¿”å›ç»“æœç»™å‰ç«¯

## ğŸ¯ å…·ä½“å®ç°å»ºè®®

### 1. åç«¯APIå±‚å®ç°

```python
# codes/backend/app/api/conversations.py
@router.post("/send-message")
async def send_message(
    message_data: SendMessageRequest,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """å‘é€æ¶ˆæ¯å¹¶å­˜å‚¨å¯¹è¯æ—¥å¿—"""
    
    # 1. è°ƒç”¨RAGæœåŠ¡è·å–AIå›ç­”
    rag_response = await call_rag_service(message_data.content)
    
    # 2. å­˜å‚¨ç”¨æˆ·æ¶ˆæ¯
    user_message = Message(
        conversation_id=message_data.conversation_id,
        user_id=current_user.id,
        content=message_data.content,
        role="user"
    )
    
    # 3. å­˜å‚¨AIå›ç­”
    ai_message = Message(
        conversation_id=message_data.conversation_id,
        user_id=None,
        content=rag_response['answer'],
        role="assistant"
    )
    
    # 4. ä¿å­˜åˆ°æ•°æ®åº“
    db.add(user_message)
    db.add(ai_message)
    db.commit()
    
    return SendMessageResponse(
        message=user_message,
        ai_response=rag_response['answer']
    )
```

### 2. RAGæœåŠ¡å±‚ç®€åŒ–

```python
# codes/services/knowledge_retrieval_service/core/rag_pipeline.py
class RAGPipeline:
    def chat(self, messages: List[Dict[str, str]], top_k: int = 5):
        """ä¸“æ³¨äºçŸ¥è¯†æ£€ç´¢å’ŒAIå›ç­”ç”Ÿæˆ"""
        
        # 1. çŸ¥è¯†æ£€ç´¢
        documents = self.retriever.retrieve(messages[-1]['content'], top_k)
        
        # 2. ç”Ÿæˆå›ç­”
        answer = self.llm.generate_answer(messages, documents)
        
        # 3. è¿”å›ç»“æœï¼ˆä¸å­˜å‚¨å¯¹è¯æ—¥å¿—ï¼‰
        return {
            'answer': answer,
            'retrieved_documents': documents,
            'timestamp': datetime.now().isoformat()
        }
```

## ğŸ¯ æ•°æ®æ¨¡å‹è®¾è®¡

### å¯¹è¯è¡¨ç»“æ„

```sql
-- å¯¹è¯ä¼šè¯è¡¨
CREATE TABLE conversations (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    title VARCHAR(255),
    status VARCHAR(50) DEFAULT 'active',
    conversation_type VARCHAR(50) DEFAULT 'medical',
    meta_data JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- æ¶ˆæ¯è¡¨
CREATE TABLE messages (
    id UUID PRIMARY KEY,
    conversation_id UUID NOT NULL,
    user_id UUID,
    content TEXT NOT NULL,
    content_type VARCHAR(50) DEFAULT 'text',
    role VARCHAR(20) NOT NULL, -- 'user' or 'assistant'
    message_data JSONB,
    is_processed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- å¯¹è¯æ—¥å¿—è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºå®¡è®¡ï¼‰
CREATE TABLE conversation_logs (
    id UUID PRIMARY KEY,
    conversation_id UUID NOT NULL,
    user_id UUID NOT NULL,
    action VARCHAR(50) NOT NULL, -- 'message_sent', 'ai_response', 'error'
    details JSONB,
    timestamp TIMESTAMP DEFAULT NOW()
);
```

## ğŸš€ å®æ–½æ­¥éª¤

### é˜¶æ®µ1ï¼šé‡æ„åç«¯API
1. ä¿®æ”¹ `codes/backend/app/api/conversations.py`
2. é›†æˆRAGæœåŠ¡è°ƒç”¨
3. å®ç°å¯¹è¯æ—¥å¿—å­˜å‚¨

### é˜¶æ®µ2ï¼šç®€åŒ–RAGæœåŠ¡
1. ç§»é™¤RAGæœåŠ¡ä¸­çš„å¯¹è¯æ—¥å¿—å­˜å‚¨é€»è¾‘
2. ä¸“æ³¨äºçŸ¥è¯†æ£€ç´¢å’ŒAIå›ç­”ç”Ÿæˆ
3. æä¾›æ ‡å‡†åŒ–çš„APIæ¥å£

### é˜¶æ®µ3ï¼šæ•°æ®è¿ç§»
1. å°†ç°æœ‰å¯¹è¯æ•°æ®è¿ç§»åˆ°åç«¯æ•°æ®åº“
2. ç»Ÿä¸€æ•°æ®æ ¼å¼å’Œå­˜å‚¨ç»“æ„
3. å®ç°æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

## ğŸ¯ æ€»ç»“

**å¯¹è¯æ—¥å¿—å­˜å‚¨åº”è¯¥æ”¾åœ¨åç«¯APIå±‚ï¼Œè€Œä¸æ˜¯RAGæœåŠ¡å±‚**

**æ ¸å¿ƒåŸåˆ™**:
1. **èŒè´£åˆ†ç¦»**: æ¯ä¸ªæœåŠ¡ä¸“æ³¨äºè‡ªå·±çš„æ ¸å¿ƒåŠŸèƒ½
2. **æ•°æ®ç»Ÿä¸€**: æ‰€æœ‰ä¸šåŠ¡æ•°æ®ç”±åç«¯ç»Ÿä¸€ç®¡ç†
3. **æ¶æ„æ¸…æ™°**: é¿å…è·¨æœåŠ¡çš„èŒè´£æ··ä¹±
4. **å¯ç»´æŠ¤æ€§**: ä¾¿äºåç»­åŠŸèƒ½æ‰©å±•å’Œç»´æŠ¤

è¿™æ ·çš„è®¾è®¡æ—¢ä¿è¯äº†ç³»ç»Ÿçš„æ¸…æ™°æ€§ï¼Œåˆç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œå®‰å…¨æ€§ã€‚
