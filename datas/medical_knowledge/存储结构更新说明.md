# 医疗知识数据存储结构更新说明

## 📋 更新概述

已成功将智诊通系统的数据存储结构统一迁移到 `datas/medical_knowledge/` 目录下，并根据纯文本、图文、语音等功能创建了相应的子文件夹。

## 🗂️ 新的目录结构

```
datas/medical_knowledge/
├── text_data/                    # 纯文本数据
│   ├── raw/                     # 原始文本数据
│   ├── processed/               # 预处理后的文本数据
│   └── embeddings/              # 文本向量化数据
├── image_text_data/             # 图文数据
│   ├── raw/                     # 原始图像和文本数据
│   ├── processed/               # 预处理后的图像和文本数据
│   └── embeddings/              # 图像和文本向量化数据
├── voice_data/                  # 语音数据
│   ├── raw/                     # 原始语音文件
│   ├── processed/               # 预处理后的语音数据
│   └── embeddings/              # 语音向量化数据
├── vector_databases/            # 向量数据库
│   ├── text/                    # 纯文本向量数据库
│   ├── image/                   # 图像向量数据库
│   ├── voice/                   # 语音向量数据库
│   └── multimodal/              # 多模态向量数据库
├── training_data/               # 训练数据
├── test_data/                   # 测试数据
└── logs/                        # 日志文件
```

## 🔧 主要更新内容

### 1. 创建了医疗知识管理器
- **文件**: `codes/ai_models/embedding_models/core/medical_knowledge_manager.py`
- **功能**: 统一管理不同类型数据的存储路径和操作
- **特性**: 
  - 自动创建目录结构
  - 路径映射和验证
  - 数据摘要统计
  - 文件操作管理

### 2. 更新了配置文件
- **统一配置**: `config/medical_knowledge_config.json`
- **更新现有配置**: 所有配置文件中的路径已更新为新结构
- **支持的数据类型**: text, image_text, voice, multimodal

### 3. 修改了核心代码
- **图像向量化**: `core/image_vectorization.py` - 使用新的路径管理
- **文本预处理**: `processors/text_preprocessing.py` - 更新输出路径
- **图像文本预处理**: `processors/image_text_preprocessing.py` - 适配新结构

### 4. 创建了测试脚本
- **简单测试**: `test_simple_structure.py` - 验证基础功能
- **完整测试**: `test_medical_knowledge_structure.py` - 全面测试

## 📊 数据迁移状态

### 已迁移的数据
- **文本数据**: 3个文件已从原始位置迁移到 `text_data/raw/`
  - GBT 14396-2016(疾病分类与代码).pdf
  - 临床路径.xlsx
  - 国家临床版2.0疾病诊断编码（ICD-10）.xlsx

- **图像数据**: 1个目录已迁移到 `image_text_data/raw/`
  - chestX-rays/

### 待处理的数据
- **processed_vqa_data/**: 原VQA数据目录，现在为空
- **其他原始数据**: 需要根据类型迁移到对应目录

## 🚀 使用方法

### 1. 获取数据路径
```python
from core.medical_knowledge_manager import MedicalKnowledgeManager

manager = MedicalKnowledgeManager()

# 获取文本数据路径
text_raw_path = manager.get_path("text", "raw")
text_processed_path = manager.get_path("text", "processed", "data.csv")

# 获取图像数据路径
image_raw_path = manager.get_path("image_text", "raw")
image_embeddings_path = manager.get_path("image_text", "embeddings", "vectors.npy")

# 获取向量数据库路径
vector_db_path = manager.get_vector_db_path("text")
```

### 2. 数据摘要
```python
summary = manager.get_data_summary()
print(json.dumps(summary, indent=2, ensure_ascii=False))
```

### 3. 文件操作
```python
# 列出文件
files = manager.list_files("text", "raw", "*.txt")

# 清理旧文件
cleaned_count = manager.cleanup_old_files("text", "processed", days=30)
```

## ✅ 测试结果

所有测试已通过，新存储结构工作正常：

- ✅ 目录结构创建成功
- ✅ 路径生成正确
- ✅ 数据类型映射正常
- ✅ 文件操作功能正常
- ✅ 数据摘要统计准确

## 📝 注意事项

1. **向后兼容**: 旧的 `processed_vqa_data/` 目录仍然存在，但建议使用新结构
2. **配置更新**: 所有相关配置文件已更新，无需手动修改
3. **数据迁移**: 现有数据已自动迁移到新结构
4. **日志记录**: 所有操作都有详细的日志记录

## 🔄 后续工作

1. **数据迁移**: 将其他原始数据迁移到对应目录
2. **功能扩展**: 根据实际需求添加更多数据类型支持
3. **性能优化**: 优化大数据量处理性能
4. **监控告警**: 添加存储空间和性能监控

## 📞 技术支持

如有问题，请查看：
- 日志文件: `datas/medical_knowledge/logs/medical_knowledge_manager.log`
- 测试脚本: `test_simple_structure.py`
- 配置文档: `datas/medical_knowledge/README.md`
