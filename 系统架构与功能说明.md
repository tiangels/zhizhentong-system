# 智诊通系统 - 架构与功能说明文档

## 📋 目录

- [系统概述](#系统概述)
- [技术架构](#技术架构)
- [后端系统](#后端系统)
  - [技术栈](#后端技术栈)
  - [目录结构](#后端目录结构)
  - [核心模块](#后端核心模块)
  - [API接口](#api接口)
  - [数据模型](#数据模型)
- [前端系统](#前端系统)
  - [技术栈](#前端技术栈)
  - [目录结构](#前端目录结构)
  - [核心模块](#前端核心模块)
  - [页面组件](#页面组件)
  - [状态管理](#状态管理)
- [数据库设计](#数据库设计)
- [系统部署](#系统部署)
- [开发规范](#开发规范)

## 🎯 系统概述

**智诊通**（ZhiZhenTong）是一个基于人工智能的多模态智能医生问诊系统，旨在为用户提供便捷、智能的医疗咨询服务。

### 核心特性

- 🧠 **智能问诊**: 基于AI的症状分析和医疗建议
- 🎯 **多模态输入**: 支持文本、语音、图像等多种输入方式
- 💬 **实时对话**: WebSocket实现流畅的对话体验
- 🔐 **用户认证**: 完整的注册登录和权限管理
- 📱 **响应式设计**: 适配桌面端和移动端
- 🚀 **微服务架构**: 模块化设计，易于扩展

### 业务场景

1. **症状咨询**: 用户描述症状，AI提供初步分析
2. **健康指导**: 提供日常健康建议和预防措施
3. **用药咨询**: 药物使用指导和注意事项
4. **就医推荐**: 根据症状严重程度推荐就医方案

## 🏗️ 技术架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
├─────────────────────────────────────────────────────────────┤
│  Web浏览器  │  移动端APP  │  微信小程序  │  桌面应用        │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                      前端层 (Vue 3)                         │
├─────────────────────────────────────────────────────────────┤
│  页面组件  │  状态管理  │  路由管理  │  HTTP客户端         │
│  Ant Design Vue  │  Pinia  │  Vue Router  │  Axios         │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                    API网关层 (FastAPI)                      │
├─────────────────────────────────────────────────────────────┤
│  认证授权  │  请求路由  │  参数验证  │  响应格式化         │
│  JWT Token │  Swagger文档 │  CORS处理 │  错误处理          │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层                              │
├─────────────────────────────────────────────────────────────┤
│ 用户管理 │ 对话管理 │ 诊断分析 │ 知识检索 │ 多模态处理    │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                       AI服务层                               │
├─────────────────────────────────────────────────────────────┤
│  大语言模型  │  向量化服务  │  RAG检索  │  多模态处理      │
│  Medical_Qwen3_17B │ text2vec │ 知识检索 │ 跨模态检索      │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                              │
├─────────────────────────────────────────────────────────────┤
│   关系数据库   │   向量数据库   │   缓存数据库   │  文件存储  │
│   PostgreSQL   │   ChromaDB     │   Redis        │  本地/OSS  │
└─────────────────────────────────────────────────────────────┘
```

### 核心模块架构

```
┌─────────────────────────────────────────────────────────────┐
│                    智诊通系统核心模块                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   前端模块      │    │   后端模块      │                │
│  │  (Vue 3)        │    │  (FastAPI)      │                │
│  │                 │    │                 │                │
│  │ • 用户界面      │    │ • 业务逻辑      │                │
│  │ • 状态管理      │    │ • 数据库管理    │                │
│  │ • 路由管理      │    │ • 用户认证      │                │
│  └─────────────────┘    └─────────────────┘                │
│           │                       │                        │
│           └───────────┬───────────┘                        │
│                       │                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              RAG检索增强模块                            │ │
│  │  (knowledge_retrieval_service)                          │ │
│  │                                                         │ │
│  │ • 知识检索                                              │ │
│  │ • AI回答生成                                            │ │
│  │ • 向量化处理                                            │ │
│  └─────────────────────────────────────────────────────────┘ │
│                       │                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              向量化知识库模块                            │ │
│  │  (embedding_models)                                     │ │
│  │                                                         │ │
│  │ • 文档处理                                              │ │
│  │ • 向量化                                                │ │
│  │ • 索引构建                                              │ │
│  └─────────────────────────────────────────────────────────┘ │
│                       │                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              大语言模型模块                              │ │
│  │  (llm_models)                                           │ │
│  │                                                         │ │
│  │ • Medical_Qwen3_17B                                     │ │
│  │ • text2vec-base-chinese                                 │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 架构特点

- **前后端分离**: 前端Vue3 + 后端FastAPI，通过RESTful API通信
- **微服务设计**: 模块化的业务服务，便于独立开发和部署
- **异步处理**: 支持高并发的异步请求处理
- **多模态支持**: 统一的多模态数据处理管道
- **可扩展性**: 插件化的AI模型集成机制
- **RAG增强**: 基于检索增强生成的智能问答系统
- **向量化存储**: 高效的向量数据库支持语义检索
- **容器化部署**: 完整的Docker化部署方案

## 🔧 后端系统

### 后端技术栈

| 技术组件 | 版本 | 用途 |
|----------|------|------|
| **Python** | 3.8+ | 开发语言 |
| **FastAPI** | 0.104+ | Web框架 |
| **SQLAlchemy** | 2.0+ | ORM框架 |
| **Pydantic** | 2.5+ | 数据验证 |
| **Uvicorn** | 0.24+ | ASGI服务器 |
| **PostgreSQL** | 13.0+ | 主数据库 |
| **Redis** | 6.0+ | 缓存数据库 |
| **JWT** | - | 身份认证 |
| **Swagger** | - | API文档 |

## 🤖 RAG检索增强系统

### RAG系统技术栈

| 技术组件 | 版本 | 用途 |
|----------|------|------|
| **Medical_Qwen3_17B** | - | 医疗大语言模型 |
| **text2vec-base-chinese** | - | 中文文本向量化模型 |
| **ChromaDB** | - | 向量数据库 |
| **FAISS** | 1.7.0+ | 向量检索库 |
| **sentence-transformers** | 2.2.0+ | 句子向量化 |
| **transformers** | 4.20.0+ | 模型加载和推理 |

### RAG系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    RAG检索增强系统                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   向量化服务    │    │   检索服务      │                │
│  │  (VectorService)│    │  (RetrievalService)              │
│  │                 │    │                 │                │
│  │ • 文本向量化    │    │ • 相似度检索    │                │
│  │ • 图像向量化    │    │ • 结果排序      │                │
│  │ • 批量处理      │    │ • 上下文构建    │                │
│  └─────────────────┘    └─────────────────┘                │
│           │                       │                        │
│           └───────────┬───────────┘                        │
│                       │                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              LLM生成服务                                │ │
│  │  (LLMService)                                          │ │
│  │                                                         │ │
│  │ • 医疗回答生成                                          │ │
│  │ • 上下文理解                                            │ │
│  │ • 多轮对话                                              │ │
│  └─────────────────────────────────────────────────────────┘ │
│                       │                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              RAG管道服务                                │ │
│  │  (RAGPipeline)                                         │ │
│  │                                                         │ │
│  │ • 端到端流程                                            │ │
│  │ • 错误处理                                              │ │
│  │ • 日志记录                                              │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 🧠 向量化知识库系统

### 向量化系统技术栈

| 技术组件 | 版本 | 用途 |
|----------|------|------|
| **text2vec-base-chinese** | - | 中文文本向量化 |
| **CLIP** | - | 图像向量化 |
| **ChromaDB** | - | 向量数据库存储 |
| **FAISS** | 1.7.0+ | 向量索引构建 |
| **sentence-transformers** | 2.2.0+ | 句子向量化 |
| **transformers** | 4.20.0+ | 模型加载 |

### 向量化系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                   向量化知识库系统                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   数据处理      │    │   向量化服务    │                │
│  │  (DataPipeline) │    │  (VectorizationService)          │
│  │                 │    │                 │                │
│  │ • 文档加载      │    │ • 文本向量化    │                │
│  │ • 数据清洗      │    │ • 图像向量化    │                │
│  │ • 文档切分      │    │ • 批量处理      │                │
│  └─────────────────┘    └─────────────────┘                │
│           │                       │                        │
│           └───────────┬───────────┘                        │
│                       │                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              跨模态检索服务                              │ │
│  │  (CrossModalRetrieval)                                 │ │
│  │                                                         │ │
│  │ • 文本到图像检索                                        │ │
│  │ • 图像到文本检索                                        │ │
│  │ • 混合检索                                              │ │
│  └─────────────────────────────────────────────────────────┘ │
│                       │                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              向量数据库构建                              │ │
│  │  (BuildVectorDatabase)                                 │ │
│  │                                                         │ │
│  │ • 索引构建                                              │ │
│  │ • 质量检查                                              │ │
│  │ • 持久化存储                                            │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 🗄️ 数据存储系统

### 数据存储架构

| 存储类型 | 技术栈 | 用途 |
|----------|--------|------|
| **关系数据库** | PostgreSQL | 用户数据、对话记录、系统配置 |
| **向量数据库** | ChromaDB | 医疗知识向量、文档向量 |
| **缓存数据库** | Redis | 会话缓存、临时数据 |
| **文件存储** | 本地/OSS | 上传文件、模型文件 |

### 数据流向

```
┌─────────────────────────────────────────────────────────────┐
│                      数据流向图                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  原始数据 → 数据预处理 → 向量化 → 向量数据库                │
│     ↓           ↓         ↓         ↓                      │
│  医疗文档    清洗切分    向量表示   索引存储                │
│                                                             │
│  用户查询 → 查询向量化 → 相似度检索 → 结果返回              │
│     ↓           ↓         ↓         ↓                      │
│  问题输入    向量表示    检索匹配   答案生成                │
│                                                             │
│  对话记录 → 后端存储 → 数据库持久化 → 历史查询              │
│     ↓           ↓         ↓         ↓                      │
│  用户对话    业务逻辑    关系存储   数据检索                │
└─────────────────────────────────────────────────────────────┘
```

### 后端目录结构

```
backend/
├── app/                          # 应用核心代码
│   ├── __init__.py
│   ├── main.py                   # FastAPI应用入口
│   ├── config.py                 # 配置管理
│   ├── database.py               # 数据库连接
│   ├── auth.py                   # 认证中间件
│   ├── cache.py                  # 缓存管理
│   │
│   ├── api/                      # API路由层
│   │   ├── __init__.py
│   │   ├── auth.py               # 认证API
│   │   ├── conversations.py      # 对话API
│   │   ├── diagnosis.py          # 诊断API
│   │   ├── knowledge.py          # 知识库API
│   │   ├── multimodal.py         # 多模态API
│   │   ├── system.py             # 系统管理API
│   │   └── v1/                   # API版本管理
│   │       └── __init__.py
│   │
│   ├── models/                   # 数据模型层
│   │   ├── __init__.py
│   │   ├── base.py               # 基础模型
│   │   ├── user.py               # 用户模型
│   │   ├── conversation.py       # 对话模型
│   │   ├── diagnosis.py          # 诊断模型
│   │   ├── knowledge.py          # 知识模型
│   │   ├── multimodal.py         # 多模态模型
│   │   ├── preference.py         # 用户偏好模型
│   │   ├── config.py             # 系统配置模型
│   │   └── log.py                # 日志模型
│   │
│   └── modules/                  # 业务逻辑层
│       ├── conversation/         # 对话管理模块
│       │   ├── __init__.py
│       │   ├── manager.py        # 对话管理器
│       │   ├── context.py        # 上下文管理
│       │   ├── history.py        # 历史记录
│       │   └── state.py          # 状态管理
│       │
│       ├── diagnosis/            # 诊断分析模块
│       │   ├── __init__.py
│       │   ├── analyzer.py       # 症状分析器
│       │   ├── engine.py         # 诊断引擎
│       │   ├── risk_assessor.py  # 风险评估器
│       │   └── generator.py      # 结果生成器
│       │
│       ├── multimodal/           # 多模态处理模块
│       │   ├── __init__.py
│       │   ├── processor.py      # 主处理器
│       │   ├── text_processor.py # 文本处理
│       │   ├── audio_processor.py# 音频处理
│       │   ├── image_processor.py# 图像处理
│       │   └── fusion.py         # 模态融合
│       │
│       └── rag/                  # RAG检索模块
│           ├── __init__.py
│           ├── retriever.py      # 检索器
│           ├── embedder.py       # 向量化器
│           ├── ranker.py         # 排序器
│           └── generator.py      # 生成器
│
├── logs/                         # 日志文件
├── uploads/                      # 上传文件
├── scripts/                      # 脚本文件
│   └── init-db.sql              # 数据库初始化
├── tests/                        # 测试文件
├── requirements.txt              # Python依赖
├── Dockerfile                    # Docker配置
├── docker-compose.yml            # 容器编排
└── start-dev.sh                  # 开发启动脚本
```

### 后端核心模块

#### 1. 用户认证模块 (auth.py)

**功能**: 处理用户注册、登录、权限验证

```python
# 核心功能
- 用户注册/登录
- JWT Token生成和验证
- 权限控制和中间件
- 会话管理
```

**主要接口**:
- `POST /auth/register` - 用户注册
- `POST /auth/login` - 用户登录
- `POST /auth/refresh` - 刷新令牌
- `GET /auth/me` - 获取用户信息

#### 2. 对话管理模块 (conversations.py)

**功能**: 管理用户对话和消息历史

```python
# 核心功能
- 创建和管理对话会话
- 消息发送和接收
- 对话历史记录
- 上下文状态维护
```

**主要接口**:
- `POST /conversations/` - 创建对话
- `GET /conversations/` - 获取对话列表
- `POST /conversations/{id}/send` - 发送消息
- `GET /conversations/{id}/messages` - 获取消息历史

#### 3. 智能诊断模块 (diagnosis.py)

**功能**: AI驱动的医疗诊断分析

```python
# 核心功能
- 症状分析和理解
- 疾病风险评估
- 诊断建议生成
- 就医推荐
```

**主要接口**:
- `POST /diagnosis/analyze` - 诊断分析
- `GET /diagnosis/` - 获取诊断记录
- `GET /diagnosis/stats` - 诊断统计

#### 4. 知识库检索模块 (knowledge.py)

**功能**: 医疗知识检索和RAG增强

```python
# 核心功能
- 医疗知识搜索
- RAG检索增强生成
- 知识库管理
- 向量相似度匹配
```

**主要接口**:
- `POST /knowledge/search` - 知识搜索
- `POST /knowledge/retrieve` - RAG检索
- `GET /knowledge/` - 获取知识列表

#### 5. 多模态处理模块 (multimodal.py)

**功能**: 处理文本、语音、图像等多种输入

```python
# 核心功能
- 文本预处理和理解
- 语音识别和转换
- 图像分析和识别
- 多模态数据融合
```

**主要接口**:
- `POST /multimodal/process` - 综合处理
- `POST /multimodal/text` - 文本处理
- `POST /multimodal/audio` - 音频处理
- `POST /multimodal/image` - 图像处理

#### 6. 系统管理模块 (system.py)

**功能**: 系统配置和用户偏好管理

```python
# 核心功能
- 系统配置管理
- 用户偏好设置
- 操作日志记录
- 系统监控
```

**主要接口**:
- `GET /system/config` - 获取系统配置
- `GET /system/preferences` - 获取用户偏好
- `GET /system/logs` - 获取操作日志

### API接口

#### API设计原则

1. **RESTful风格**: 遵循REST设计原则
2. **统一响应格式**: 标准化的JSON响应结构
3. **版本管理**: 支持API版本控制
4. **错误处理**: 完整的错误码和错误信息
5. **文档生成**: 自动生成Swagger文档

#### 统一响应格式

```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "code": 200,
  "timestamp": "2024-01-01T00:00:00Z"
}
```

#### 认证机制

```bash
# JWT Token认证
Authorization: Bearer <access_token>

# Token刷新机制
POST /auth/refresh
{
  "refresh_token": "refresh_token_here"
}
```

### 数据模型

#### 核心实体关系

```
User (用户)
├── UserSession (会话)
├── Conversation (对话)
│   └── Message (消息)
├── Diagnosis (诊断)
├── UserPreference (偏好)
└── OperationLog (日志)

MedicalKnowledge (医疗知识)
├── 症状知识
├── 疾病知识
├── 治疗知识
└── 药物知识

MultimodalInput/Output (多模态数据)
├── 文本数据
├── 音频数据
├── 图像数据
└── 融合结果
```

## 🎨 前端系统

### 前端技术栈

| 技术组件 | 版本 | 用途 |
|----------|------|------|
| **Vue** | 3.4+ | 前端框架 |
| **TypeScript** | 5.3+ | 类型系统 |
| **Vite** | 5.0+ | 构建工具 |
| **Pinia** | 2.1+ | 状态管理 |
| **Vue Router** | 4.2+ | 路由管理 |
| **Ant Design Vue** | 4.0+ | UI组件库 |
| **Axios** | 1.6+ | HTTP客户端 |
| **Less** | 4.2+ | CSS预处理器 |

### 前端目录结构

```
frontend/
├── src/                          # 源代码
│   ├── main.ts                   # 应用入口
│   ├── App.vue                   # 根组件
│   │
│   ├── assets/                   # 静态资源
│   │   ├── images/               # 图片资源
│   │   ├── icons/                # 图标资源
│   │   └── styles/               # 样式文件
│   │       ├── variables.less    # 样式变量
│   │       ├── global.less       # 全局样式
│   │       └── mixins.less       # 样式混入
│   │
│   ├── components/               # 公共组件
│   │   ├── common/               # 通用组件
│   │   │   ├── Loading.vue       # 加载组件
│   │   │   ├── Modal.vue         # 弹窗组件
│   │   │   └── Button.vue        # 按钮组件
│   │   │
│   │   ├── input/                # 输入组件
│   │   │   ├── TextInput.vue     # 文本输入
│   │   │   ├── VoiceInput.vue    # 语音输入
│   │   │   └── ImageInput.vue    # 图片输入
│   │   │
│   │   ├── chat/                 # 聊天组件
│   │   │   ├── MessageList.vue   # 消息列表
│   │   │   ├── MessageItem.vue   # 消息项
│   │   │   └── InputArea.vue     # 输入区域
│   │   │
│   │   └── layout/               # 布局组件
│   │       ├── MainLayout.vue    # 主布局
│   │       └── AuthLayout.vue    # 认证布局
│   │
│   ├── views/                    # 页面组件
│   │   ├── auth/                 # 认证页面
│   │   │   ├── AuthLayout.vue    # 认证布局
│   │   │   ├── Login.vue         # 登录页
│   │   │   └── Register.vue      # 注册页
│   │   │
│   │   ├── chat/                 # 聊天页面
│   │   │   ├── ChatLayout.vue    # 聊天布局
│   │   │   ├── ChatWindow.vue    # 聊天窗口
│   │   │   └── ChatHistory.vue   # 聊天历史
│   │   │
│   │   ├── profile/              # 用户页面
│   │   │   └── UserProfile.vue   # 用户档案
│   │   │
│   │   ├── settings/             # 设置页面
│   │   │   └── AppSettings.vue   # 应用设置
│   │   │
│   │   ├── error/                # 错误页面
│   │   │   └── NotFound.vue      # 404页面
│   │   │
│   │   ├── Dashboard.vue         # 仪表盘
│   │   └── SimplePage.vue        # 简单页面
│   │
│   ├── stores/                   # 状态管理
│   │   ├── auth.ts               # 认证状态
│   │   ├── chat.ts               # 聊天状态
│   │   └── ui.ts                 # UI状态
│   │
│   ├── services/                 # 服务层
│   │   ├── api/                  # API服务
│   │   │   └── index.ts          # API配置
│   │   ├── apiService.ts         # 业务API
│   │   └── mockApi.ts            # 模拟API
│   │
│   ├── router/                   # 路由配置
│   │   └── index.ts              # 路由定义
│   │
│   ├── types/                    # 类型定义
│   │   └── index.ts              # 全局类型
│   │
│   ├── utils/                    # 工具函数
│   │   ├── constants.ts          # 常量定义
│   │   ├── helpers.ts            # 辅助函数
│   │   ├── validators.ts         # 验证函数
│   │   └── storage.ts            # 存储工具
│   │
│   └── constants/                # 常量配置
│       └── index.ts              # 应用常量
│
├── public/                       # 公共资源
│   ├── favicon.ico               # 网站图标
│   └── index.html                # HTML模板
│
├── dist/                         # 构建输出
├── node_modules/                 # 依赖包
├── package.json                  # 项目配置
├── vite.config.ts                # Vite配置
├── tsconfig.json                 # TS配置
├── .eslintrc.js                  # ESLint配置
├── Dockerfile                    # Docker配置
└── start-dev.sh                  # 启动脚本
```

### 前端核心模块

#### 1. 路由管理 (router/index.ts)

**功能**: 页面路由和导航守卫

```typescript
// 核心路由
- / (首页)
- /auth/login (登录)
- /auth/register (注册)
- /dashboard (仪表盘)
- /chat (智能问诊)
- /chat/:id (对话详情)
- /chat/history (对话历史)
- /profile (用户档案)
- /settings (应用设置)
```

#### 2. 状态管理 (stores/)

**认证状态** (auth.ts):
```typescript
interface AuthState {
  user: User | null
  token: string | null
  isLoggedIn: boolean
  loading: boolean
}
```

**聊天状态** (chat.ts):
```typescript
interface ChatState {
  conversations: Conversation[]
  currentConversation: Conversation | null
  messages: Message[]
  loading: boolean
}
```

**UI状态** (ui.ts):
```typescript
interface UIState {
  sidebarCollapsed: boolean
  theme: 'light' | 'dark'
  loading: boolean
}
```

#### 3. API服务 (services/)

**HTTP客户端配置**:
```typescript
// 基础配置
const api = axios.create({
  baseURL: 'http://localhost:8000',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// 请求拦截器
api.interceptors.request.use(config => {
  const token = getToken()
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})
```

### 页面组件

#### 1. 认证页面

- **登录页面** (Login.vue): 用户登录界面
- **注册页面** (Register.vue): 用户注册界面
- **认证布局** (AuthLayout.vue): 认证页面通用布局

#### 2. 主要功能页面

- **仪表盘** (Dashboard.vue): 系统概览和快捷入口
- **聊天窗口** (ChatWindow.vue): 智能问诊对话界面
- **聊天历史** (ChatHistory.vue): 历史对话记录
- **用户档案** (UserProfile.vue): 个人信息管理
- **应用设置** (AppSettings.vue): 系统参数配置

#### 3. 布局组件

- **主布局** (MainLayout.vue): 应用主要布局框架
- **认证布局** (AuthLayout.vue): 认证相关页面布局

### 状态管理

#### Pinia Store设计

**模块化设计**:
```typescript
// 认证模块
export const useAuthStore = defineStore('auth', {
  state: () => ({
    user: null,
    token: localStorage.getItem('token'),
    isLoggedIn: false
  }),
  
  actions: {
    async login(credentials) { ... },
    async logout() { ... },
    async refreshToken() { ... }
  }
})

// 聊天模块
export const useChatStore = defineStore('chat', {
  state: () => ({
    conversations: [],
    currentConversation: null,
    messages: []
  }),
  
  actions: {
    async sendMessage(message) { ... },
    async loadConversations() { ... },
    async createConversation() { ... }
  }
})
```

## 🗄️ 数据库设计

### 数据库架构

```sql
-- 用户表
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 对话表
CREATE TABLE conversations (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    title VARCHAR(200),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 消息表
CREATE TABLE messages (
    id INTEGER PRIMARY KEY,
    conversation_id INTEGER NOT NULL,
    content TEXT NOT NULL,
    message_type VARCHAR(20) DEFAULT 'text',
    sender_type VARCHAR(20) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id)
);

-- 诊断记录表
CREATE TABLE diagnoses (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    conversation_id INTEGER,
    symptoms TEXT NOT NULL,
    diagnosis_result TEXT,
    confidence_score FLOAT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (conversation_id) REFERENCES conversations(id)
);

-- 医疗知识表
CREATE TABLE medical_knowledge (
    id INTEGER PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    category VARCHAR(50),
    tags TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 数据关系图

```
User (用户)
├─ 1:N → Conversation (对话)
│  └─ 1:N → Message (消息)
├─ 1:N → Diagnosis (诊断记录)
├─ 1:1 → UserPreference (用户偏好)
└─ 1:N → OperationLog (操作日志)

MedicalKnowledge (医疗知识)
└─ M:N → Diagnosis (诊断记录)

SystemConfig (系统配置)
└─ 全局配置项
```

## 🚀 系统部署

### 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                      负载均衡层                              │
├─────────────────────────────────────────────────────────────┤
│                    Nginx / Traefik                          │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                      应用服务层                              │
├─────────────────────────────────────────────────────────────┤
│    前端服务         │           后端服务                     │
│  (Vue 3 + Nginx)   │      (FastAPI + Uvicorn)              │
└─────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                              │
├─────────────────────────────────────────────────────────────┤
│  PostgreSQL  │    Redis     │   Milvus    │   文件存储     │
│  (主数据库)   │   (缓存)     │  (向量库)    │   (OSS/本地)   │
└─────────────────────────────────────────────────────────────┘
```

### Docker部署

#### 1. Docker Compose配置

```yaml
version: '3.8'

services:
  # 前端服务
  frontend:
    build: ./frontend
    ports:
      - "8080:80"
    depends_on:
      - backend
    environment:
      - VITE_API_BASE_URL=http://backend:8000

  # 后端服务
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - redis
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/zhizhentong
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs

  # 数据库
  postgres:
    image: postgres:13
    environment:
      - POSTGRES_DB=zhizhentong
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # 缓存
  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"

volumes:
  postgres_data:
```

#### 2. 部署命令

```bash
# 构建和启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 生产环境部署

#### 1. 服务器要求

- **CPU**: 4核心以上
- **内存**: 8GB以上
- **磁盘**: 100GB以上SSD
- **网络**: 10Mbps以上带宽

#### 2. 环境配置

```bash
# 系统依赖
sudo apt update
sudo apt install docker.io docker-compose nginx certbot

# SSL证书配置
sudo certbot --nginx -d yourdomain.com

# 防火墙配置
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 22
```

## 📋 开发规范

### 代码规范

#### 1. Python代码规范

```python
# 使用Black格式化
black --line-length 88 .

# 使用isort排序导入
isort .

# 使用flake8检查
flake8 --max-line-length 88
```

#### 2. TypeScript代码规范

```bash
# 使用ESLint检查
npm run lint

# 使用Prettier格式化
npm run format

# 类型检查
npm run type-check
```

### Git工作流

#### 1. 分支策略

```
main (主分支)
├── develop (开发分支)
├── feature/* (功能分支)
├── hotfix/* (热修复分支)
└── release/* (发布分支)
```

#### 2. 提交规范

```bash
# 提交格式
<type>(<scope>): <subject>

# 类型说明
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式
refactor: 重构
test: 测试
chore: 构建工具

# 示例
feat(auth): 添加用户注册功能
fix(chat): 修复消息发送失败问题
docs(readme): 更新安装说明
```

### 测试策略

#### 1. 后端测试

```python
# 单元测试
pytest tests/unit/

# 集成测试
pytest tests/integration/

# API测试
pytest tests/api/
```

#### 2. 前端测试

```bash
# 单元测试
npm run test:unit

# E2E测试
npm run test:e2e

# 覆盖率测试
npm run test:coverage
```

### 监控和日志

#### 1. 日志配置

```python
# 后端日志
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/app.log'),
        logging.StreamHandler()
    ]
)
```

#### 2. 性能监控

```bash
# 系统监控
htop
iotop
netstat -tulpn

# 应用监控
docker stats
docker logs -f container_name
```

---

**开发团队**: 智诊通开发团队  
**更新时间**: 2024年  
**文档版本**: 1.0.0
